<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heladería - Menú de Productos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Liberation Sans', 'Helvetica Neue', Arial, sans-serif;
            background: #f6f6f6;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        
        .header {
            background: #d1bb96;
            border-bottom: 3px solid #b8965f;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.2rem;
            color: #8b6914;
            font-weight: 400;
            margin-bottom: 8px;
        }
        
        .header .subtitle {
            color: #5a4a10;
            font-size: 1rem;
            font-style: italic;
        }
        
        .nav-tabs {
            background: #eaecf0;
            border-bottom: 1px solid #a2a9b1;
            padding: 0;
            margin: 0;
        }
        
        .nav-tabs ul {
            list-style: none;
            display: flex;
            margin: 0;
            padding: 0;
        }
        
        .nav-tabs li {
            margin-right: 2px;
        }
        
        .nav-tabs a {
            display: block;
            padding: 8px 16px;
            text-decoration: none;
            color: #0645ad;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-bottom: none;
            margin-bottom: -1px;
            font-size: 0.9rem;
        }
        
        .nav-tabs a:hover {
            background: #eaecf0;
        }
        
        .nav-tabs a.active {
            background: white;
            color: #8b6914;
            font-weight: bold;
            border-bottom: 1px solid white;
        }
        
        .content {
            padding: 20px;
        }
        
        .search-box {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 12px;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            font-size: 1rem;
            border-radius: 3px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #d1bb96;
            box-shadow: 0 0 3px rgba(209, 187, 150, 0.3);
        }
        
        .search-btn, .clear-btn {
            padding: 8px 12px;
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
            border: 1px solid;
        }
        
        .search-btn {
            background: #d1bb96;
            border-color: #b8965f;
            color: #8b6914;
        }
        
        .search-btn:hover {
            background: #c4a779;
        }
        
        .clear-btn {
            background: #eaecf0;
            border-color: #a2a9b1;
            color: #333;
        }
        
        .clear-btn:hover {
            background: #ddd;
        }
        
        /* Vista Categorías - Mantener tabla */
        .categorias-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .categorias-table th,
        .categorias-table td {
            border: 1px solid #a2a9b1;
            padding: 8px 12px;
            text-align: left;
        }
        
        .categorias-table th {
            background: #eaecf0;
            font-weight: bold;
            color: #333;
        }
        
        .categorias-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .categorias-table tr:hover {
            background: #fff3cd;
        }
        
        .categoria-link {
            color: #0645ad;
            text-decoration: none;
            font-weight: bold;
        }
        
        .categoria-link:hover {
            text-decoration: underline;
            color: #8b6914;
        }
        
        .categoria-icon {
            font-size: 1.5rem;
            margin-right: 8px;
        }
        
        /* Vista Productos - Cards Grid */
        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .producto-card {
            background: white;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .producto-card:hover {
            border-color: #d1bb96;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .producto-card-imagen {
            width: 100%;
            height: 180px;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .producto-card-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .producto-card-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d1bb96, #e8d5b7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .producto-card-body {
            padding: 15px;
        }
        
        .producto-card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0645ad;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .producto-card:hover .producto-card-title {
            color: #8b6914;
        }
        
        .producto-card-descripcion {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .producto-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #eaecf0;
            margin-top: 10px;
        }
        
        .producto-card-precio {
            color: #0e7c00;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .producto-card-categoria {
            background: #eaecf0;
            color: #666;
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 12px;
            border: 1px solid #a2a9b1;
        }
        
        .breadcrumb {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 8px 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-radius: 3px;
        }
        
        .breadcrumb a {
            color: #0645ad;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
            color: #8b6914;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .no-results {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            padding: 40px;
            text-align: center;
            color: #666;
            margin: 20px 0;
            border-radius: 3px;
            grid-column: 1 / -1;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #d00;
            padding: 12px;
            margin: 20px 0;
            border-radius: 3px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border: 2px solid #a2a9b1;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border-radius: 6px;
        }
        
        .modal-header {
            background: #eaecf0;
            padding: 15px;
            border-bottom: 1px solid #a2a9b1;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        .modal-image {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: cover;
            border: 1px solid #a2a9b1;
            float: right;
            margin-left: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .modal-placeholder {
            width: 100%;
            max-width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #d1bb96, #e8d5b7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            float: right;
            margin-left: 15px;
            margin-bottom: 15px;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                box-shadow: none;
            }
            
            .content {
                padding: 15px;
            }
            
            .nav-tabs ul {
                flex-wrap: wrap;
            }
            
            .nav-tabs li {
                margin-right: 0;
                margin-bottom: 2px;
                flex: 1;
                min-width: 120px;
            }
            
            .nav-tabs a {
                text-align: center;
            }
            
            .search-input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .search-btn,
            .clear-btn {
                margin-left: 0;
                margin-right: 8px;
                margin-bottom: 5px;
            }
            
            .productos-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .categorias-table {
                font-size: 0.9rem;
            }
            
            .categorias-table th,
            .categorias-table td {
                padding: 6px 8px;
            }
            
            .modal-image,
            .modal-placeholder {
                float: none;
                margin: 0 auto 15px;
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .productos-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .producto-card-imagen {
                height: 150px;
            }
            
            .producto-card-body {
                padding: 12px;
            }
            
            .producto-card-title {
                font-size: 1.1rem;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-body {
                padding: 15px;
            }
        }
        
        /* Mejoras adicionales para mobile-first */
        @media (max-width: 320px) {
            .content {
                padding: 10px;
            }
            
            .search-box {
                padding: 8px;
            }
            
            .producto-card-body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍦 Heladería</h1>
            <div class="subtitle">Menú completo de productos y categorías</div>
        </div>
        
        <nav class="nav-tabs">
            <ul>
                <li><a href="#" id="tab-categorias" class="active" onclick="cambiarVista('categorias')">Categorías</a></li>
                <li><a href="#" id="tab-productos" onclick="cambiarVista('productos')">Todos los productos</a></li>
            </ul>
        </nav>
        
        <div class="content">
            <!-- Vista Categorías -->
            <div id="vista-categorias">
                <div class="search-box">
                    <input type="text" id="buscar-categoria" class="search-input" placeholder="Buscar categoría..." onkeydown="buscarEnter(event, 'categoria')">
                    <button class="search-btn" onclick="filtrarCategorias()">Buscar</button>
                    <button class="clear-btn" onclick="limpiarFiltroCategoria()" id="clear-categoria" style="display:none">Limpiar</button>
                </div>
                
                <div id="contenido-categorias">
                    <div class="loading">Cargando categorías...</div>
                </div>
            </div>
            
            <!-- Vista Productos -->
            <div id="vista-productos" style="display:none">
                <div class="breadcrumb" id="breadcrumb" style="display:none">
                    <a href="#" onclick="cambiarVista('categorias')">Inicio</a> &gt; <span id="categoria-actual">Productos</span>
                </div>
                
                <div class="search-box">
                    <input type="text" id="buscar-producto" class="search-input" placeholder="Buscar producto..." onkeydown="buscarEnter(event, 'producto')">
                    <button class="search-btn" onclick="filtrarProductos()">Buscar</button>
                    <button class="clear-btn" onclick="limpiarFiltroProducto()" id="clear-producto" style="display:none">Limpiar</button>
                </div>
                
                <div id="contenido-productos">
                    <div class="loading">Cargando productos...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal" style="display:none" onclick="cerrarModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                Detalles del producto
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase
        const supabaseUrl = "https://kntorhiruncbnhvvyint.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtudG9yaGlydW5jYm5odnZ5aW50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MTY1NjYsImV4cCI6MjA2ODM5MjU2Nn0.PpHPi0p0e_pdTloQip0X6-_NKG7KhHw89t4Yyrvm5ow";
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variables globales
        let productos = [];
        let categorias = [];
        let vistaActual = 'categorias';
        let categoriaSeleccionada = null;
        let filtroTexto = '';
        let filtroCategoria = '';
        
        // Emojis para categorías
        const categoriasEmojis = {
            'helados': '🍦',
            'postres': '🍰',
            'bebidas': '🥤',
            'snacks': '🍪',
            'especiales': '⭐',
            'default': '🍨'
        };
        
        // Cargar datos
        async function cargarDatos() {
            try {
                // Cargar productos con categorías
                const { data: productosData, error: productosError } = await supabase
                    .from('productos')
                    .select(`
                        *,
                        categoria:categorias(id, nombre, descripcion)
                    `)
                    .order('nombre');
                
                if (productosError) throw productosError;
                
                // Cargar categorías
                const { data: categoriasData, error: categoriasError } = await supabase
                    .from('categorias')
                    .select('*')
                    .order('nombre');
                
                if (categoriasError) throw categoriasError;
                
                productos = productosData || [];
                categorias = categoriasData || [];
                
                // Contar productos por categoría
                categorias.forEach(categoria => {
                    categoria.cantidadProductos = productos.filter(p => p.categoria_id === categoria.id).length;
                });
                
                mostrarDatos();
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarError('Error al cargar los datos. Por favor, intenta de nuevo más tarde.');
            }
        }
        
        // Mostrar datos según la vista actual
        function mostrarDatos() {
            if (vistaActual === 'categorias') {
                mostrarCategorias();
            } else {
                mostrarProductos();
            }
        }
        
        // Mostrar categorías
        function mostrarCategorias() {
            let categoriasFiltradas = categorias;
            
            if (filtroCategoria) {
                categoriasFiltradas = categorias.filter(cat => 
                    cat.nombre.toLowerCase().includes(filtroCategoria.toLowerCase()) ||
                    (cat.descripcion && cat.descripcion.toLowerCase().includes(filtroCategoria.toLowerCase()))
                );
            }
            
            const contenido = document.getElementById('contenido-categorias');
            
            if (categoriasFiltradas.length === 0) {
                contenido.innerHTML = '<div class="no-results">No se encontraron categorías.</div>';
                return;
            }
            
            let html = `
                <table class="categorias-table">
                    <thead>
                        <tr>
                            <th>Categoría</th>
                            <th>Descripción</th>
                            <th>Productos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            categoriasFiltradas.forEach(categoria => {
                const emoji = categoriasEmojis[categoria.nombre.toLowerCase()] || categoriasEmojis.default;
                html += `
                    <tr onclick="verCategoria(${categoria.id}, '${categoria.nombre}')">
                        <td>
                            <span class="categoria-icon">${emoji}</span>
                            <a href="#" class="categoria-link" onclick="event.preventDefault(); verCategoria(${categoria.id}, '${categoria.nombre}')">${categoria.nombre}</a>
                        </td>
                        <td>${categoria.descripcion || 'Sin descripción'}</td>
                        <td><strong>${categoria.cantidadProductos}</strong> productos</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contenido.innerHTML = html;
        }
        
        // Mostrar productos en formato de cards
        function mostrarProductos() {
            let productosFiltrados = productos;
            
            if (categoriaSeleccionada) {
                productosFiltrados = productosFiltrados.filter(p => p.categoria_id === categoriaSeleccionada);
            }
            
            if (filtroTexto) {
                productosFiltrados = productosFiltrados.filter(p =>
                    p.nombre.toLowerCase().includes(filtroTexto.toLowerCase()) ||
                    (p.descripcion && p.descripcion.toLowerCase().includes(filtroTexto.toLowerCase()))
                );
            }
            
            const contenido = document.getElementById('contenido-productos');
            
            if (productosFiltrados.length === 0) {
                contenido.innerHTML = '<div class="productos-grid"><div class="no-results">No se encontraron productos.</div></div>';
                return;
            }
            
            let html = '<div class="productos-grid">';
            
            productosFiltrados.forEach(producto => {
                const categoria = producto.categoria || { nombre: 'Sin categoría' };
                const descripcion = producto.descripcion || 'Sin descripción disponible';
                
                html += `
                    <div class="producto-card" onclick="mostrarDetalle(${producto.id})">
                        <div class="producto-card-imagen">
                            ${producto.imagen ? 
                                `<img src="${producto.imagen}" alt="${producto.nombre}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="producto-card-placeholder" style="display:none">🍦</div>` :
                                `<div class="producto-card-placeholder">🍦</div>`
                            }
                        </div>
                        <div class="producto-card-body">
                            <div class="producto-card-title">${producto.nombre}</div>
                            <div class="producto-card-descripcion">${descripcion}</div>
                            <div class="producto-card-footer">
                                <div class="producto-card-precio">$${producto.precio}</div>
                                <div class="producto-card-categoria">${categoria.nombre}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contenido.innerHTML = html;
        }
        
        // Cambiar vista
        function cambiarVista(vista) {
            vistaActual = vista;
            
            // Actualizar pestañas
            document.querySelectorAll('.nav-tabs a').forEach(a => a.classList.remove('active'));
            document.getElementById(`tab-${vista}`).classList.add('active');
            
            // Mostrar/ocultar contenido
            if (vista === 'categorias') {
                document.getElementById('vista-categorias').style.display = 'block';
                document.getElementById('vista-productos').style.display = 'none';
                categoriaSeleccionada = null;
            } else {
                document.getElementById('vista-categorias').style.display = 'none';
                document.getElementById('vista-productos').style.display = 'block';
                document.getElementById('breadcrumb').style.display = 'block';
                document.getElementById('categoria-actual').textContent = 'Todos los productos';
            }
            
            mostrarDatos();
        }
        
        // Ver productos de una categoría
        function verCategoria(id, nombre) {
            categoriaSeleccionada = id;
            vistaActual = 'productos';
            
            // Actualizar pestañas
            document.querySelectorAll('.nav-tabs a').forEach(a => a.classList.remove('active'));
            document.getElementById('tab-productos').classList.add('active');
            
            // Mostrar vista productos
            document.getElementById('vista-categorias').style.display = 'none';
            document.getElementById('vista-productos').style.display = 'block';
            document.getElementById('breadcrumb').style.display = 'block';
            document.getElementById('categoria-actual').textContent = nombre;
            
            mostrarProductos();
        }
        
        // Filtros
        function filtrarCategorias() {
            filtroCategoria = document.getElementById('buscar-categoria').value;
            document.getElementById('clear-categoria').style.display = filtroCategoria ? 'inline' : 'none';
            mostrarCategorias();
        }
        
        function filtrarProductos() {
            filtroTexto = document.getElementById('buscar-producto').value;
            document.getElementById('clear-producto').style.display = filtroTexto ? 'inline' : 'none';
            mostrarProductos();
        }
        
        function limpiarFiltroCategoria() {
            document.getElementById('buscar-categoria').value = '';
            filtroCategoria = '';
            document.getElementById('clear-categoria').style.display = 'none';
            mostrarCategorias();
        }
        
        function limpiarFiltroProducto() {
            document.getElementById('buscar-producto').value = '';
            filtroTexto = '';
            document.getElementById('clear-producto').style.display = 'none';
            mostrarProductos();
        }
        
        function buscarEnter(event, tipo) {
            if (event.key === 'Enter') {
                if (tipo === 'categoria') {
                    filtrarCategorias();
                } else {
                    filtrarProductos();
                }
            }
        }
        
        // Modal
        function mostrarDetalle(id) {
            const producto = productos.find(p => p.id === id);
            if (!producto) return;
            
            const categoria = producto.categoria || { nombre: 'Sin categoría' };
            
            document.getElementById('modal-body').innerHTML = `
                ${producto.imagen ? 
                    `<img src="${producto.imagen}" alt="${producto.nombre}" class="modal-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="modal-placeholder" style="display:none">🍦</div>` :
                    `<div class="modal-placeholder">🍦</div>`
                }
                <h2>${producto.nombre}</h2>
                <p><strong>Precio:</strong> <span class="precio" style="color: #0e7c00; font-weight: bold; font-size: 1.3rem;">$${producto.precio}</span></p>
                <p><strong>Categoría:</strong> ${categoria.nombre}</p>
                ${producto.descripcion ? `<p><strong>Descripción:</strong></p><p>${producto.descripcion}</p>` : ''}
            `;
            
            document.getElementById('modal').style.display = 'flex';
        }
        
        function cerrarModal(event) {
            if (!event || event.target === document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
            }
        }
        
        function mostrarError(mensaje) {
            const contenido = vistaActual === 'categorias' ? 
                document.getElementById('contenido-categorias') : 
                document.getElementById('contenido-productos');
            contenido.innerHTML = `<div class="error">${mensaje}</div>`;
        }
        
        // Inicializar
        window.addEventListener('load', cargarDatos);
        setInterval(cargarDatos, 30000);
    </script>
</body>
</html>